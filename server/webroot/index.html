<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Red - Dashboard</title>
    <script>
        // Verificaci√≥n de Sesi√≥n (Simple)
        const session = localStorage.getItem('network_session');
        if (!session) {
            window.location.href = 'login.html';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #1e293b;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .chart-card h3 {
            margin-bottom: 15px;
            color: #e2e8f0;
        }

        .chart-container {
            position: relative;
            height: 350px;
            padding: 30px 20px;
        }

        .devices-section {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }

        .devices-section h3 {
            margin-bottom: 15px;
        }

        /* Tabs Styles - Minimal Title Look */
        .tabs-header {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            font-size: 1.5rem;
            /* Title Size */
            font-weight: 700;
            color: #64748b;
            /* Dimmed */
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: #94a3b8;
        }

        .tab-btn.active {
            color: #f8fafc;
            /* Bright White */
        }

        /* Optional: Add a subtle separator or indicator if needed, 
           but user asked for 'simplemente texto' */

        .devices-table {
            width: 100%;
            border-collapse: collapse;
        }

        .devices-table th {
            background: #334155;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .devices-table td {
            padding: 12px;
            border-bottom: 1px solid #334155;
        }

        .devices-table tr:hover {
            background: #334155;
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            position: relative;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            z-index: 1001;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #334155;
            color: #e2e8f0;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #475569;
        }

        .modal-close span {
            font-size: 18px;
        }

        .device-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 60px;
        }

        .detail-card {
            background: #0f172a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .detail-card h4 {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }

        .detail-card .value {
            color: #e2e8f0;
            font-size: 1.125rem;
            font-weight: 500;
        }

        .protocol-list {
            list-style: none;
            margin-top: 10px;
        }

        .protocol-list li {
            padding: 12px;
            background: #0f172a;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .protocol-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .protocol-badge.secure {
            background: #10b981;
            color: white;
        }

        .protocol-badge.insecure {
            background: #ef4444;
            color: white;
        }

        .devices-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .device-detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üåê Monitor de Red</h1>
        <div class="status">
            <span class="status-dot" id="sse-status"></span>
            <span>Monitoreo en Tiempo Real</span>
        </div>
        <div style="position: absolute; top: 20px; right: 20px;">
            <button class="btn btn-secondary" onclick="logout()" style="padding: 5px 10px; font-size: 0.8rem;">Cerrar
                Sesi√≥n</button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Dispositivos</h3>
            <div class="value" id="stat-total">0</div>
        </div>

        <div class="stat-card">
            <h3>Protocolos Detectados</h3>
            <div class="value" id="stat-protocols">0</div>
        </div>
        <div class="stat-card">
            <h3>Protocolos Seguros</h3>
            <div class="value" id="stat-secure">0</div>
        </div>
    </div>

    <div class="actions">
        <a href="downloads/ClientAgent_Setup.exe" class="btn"
            style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 5px;"
            download>
            üì• Descargar Esc√°ner
        </a>
        <button class="btn" onclick="exportPDF()">üìÑ Exportar PDF</button>
        <button class="btn btn-secondary" onclick="exportCSV()">üìä Exportar CSV</button>
        <button class="btn btn-secondary" onclick="refreshData()">üîÑ Actualizar</button>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3 style="text-align: center;">Gr√°fico de Protocolos</h3>
            <div class="chart-container">
                <canvas id="secureChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3 style="text-align: center;">Frecuencia de Protocolos</h3>
            <div class="chart-container">
                <canvas id="deviceChart"></canvas>
            </div>
        </div>
    </div>

    <div class="devices-section">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="switchTab('devices')">Dispositivos</button>
            <button class="tab-btn" onclick="switchTab('conflicts')">Conflictos Detectados</button>
        </div>

        <!-- Tabla Dispositivos -->
        <div id="tab-devices" class="tab-content active">
            <table class="devices-table">
                <thead>
                    <tr>
                        <th>Hostname</th>
                        <th>IP</th>
                        <th>MAC</th>
                        <th>Protocolos</th>
                        <th>√öltima Detecci√≥n</th>
                    </tr>
                </thead>
                <tbody id="devices-tbody">
                    <tr>
                        <td colspan="5" style="text-align:center;">Cargando...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Tabla Conflictos -->
        <div id="tab-conflicts" class="tab-content" style="display: none;">
            <table class="devices-table">
                <thead>
                    <tr>
                        <th>IP</th>
                        <th>MAC</th>
                        <th>Hostname (Conflicto)</th>
                        <th>Descripci√≥n</th>
                        <th>Fecha Detecci√≥n</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="conflicts-tbody">
                    <tr>
                        <td colspan="6" style="text-align:center;">Cargando conflictos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Detalles del Dispositivo -->
    <div id="device-modal" class="modal">
        <div class="modal-backdrop" onclick="closeDeviceModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeDeviceModal()">
                <span>‚Üê</span> Volver
            </button>
            <div id="modal-body">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <!-- Modal de Protocolos por Categor√≠a -->
    <div id="protocol-modal" class="modal">
        <div class="modal-backdrop" onclick="closeProtocolModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeProtocolModal()">
                <span>‚Üê</span> Volver
            </button>
            <div id="protocol-modal-body">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let charts = {};
        let allData = {
            stats: {},
            protocols: {},
            devices: []
        };
        let sseConnection = null;

        // Inicializar
        async function init() {
            await loadData();
            initSSE();
            setInterval(refreshData, 30000);
        }

        function logout() {
            localStorage.removeItem('network_session');
            window.location.href = 'login.html';
        }

        // Cargar datos
        async function loadData() {
            try {
                const protocolsRes = await fetch('api/dashboard.php?action=protocol_stats');
                const protocolsData = await protocolsRes.json();

                const categoryStatsRes = await fetch('api/dashboard.php?action=category_device_stats');
                const categoryStatsData = await categoryStatsRes.json();

                const devicesRes = await fetch('api/dashboard.php?action=devices&limit=100');
                const devicesData = await devicesRes.json();

                allData.protocols = protocolsData;
                allData.categoryStats = categoryStatsData.stats || [];
                allData.devices = devicesData.data || [];
                allData.stats = {
                    total_equipos: allData.devices.length,
                    activos_5min: allData.devices.length,
                    total_protocolos: protocolsData.totals?.total || 0
                };

                updateUI();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateUI() {
            updateStats();
            updateCharts();
            updateDevicesTable();
        }

        function updateStats() {
            const stats = allData.stats;
            const protocols = allData.protocols;

            document.getElementById('stat-total').textContent = stats.total_equipos || 0;

            document.getElementById('stat-protocols').textContent = protocols.totals?.total || 0;
            document.getElementById('stat-secure').textContent = protocols.totals?.secure || 0;
        }

        function updateCharts() {
            const protocols = allData.protocols;

            // Funci√≥n para formatear nombres de categor√≠as
            const formatCategoryName = (cat) => {
                const names = {
                    'seguro': 'Seguro',
                    'inseguro': 'Inseguro',
                    'precaucion': 'Precauci√≥n',
                    'inusual': 'Inusual',
                    'esencial': 'Esencial',
                    'base_de_datos': 'Base de Datos',
                    'correo': 'Correo',
                    'gestion': 'Gesti√≥n',
                    'multimedia': 'Multimedia',
                    'juegos': 'Juegos',
                    'voz_ip': 'VoIP',
                    'archivos': 'Archivos',
                    'remoto': 'Remoto',
                    'virtualizacion': 'Virtualizaci√≥n',
                    'monitoreo': 'Monitoreo',
                    'impresion': 'Impresi√≥n',
                    'backup': 'Backup',
                    'desarrollo': 'Desarrollo',
                    'reservado': 'Reservado'
                };
                return names[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
            };

            const secureData = {
                labels: [],
                values: [],
                colors: [],
                categories: []
            };

            const colorMap = {
                'esencial': '#10b981',
                'base_de_datos': '#3b82f6',
                'archivos': '#8b5cf6',
                'precaucion': '#f59e0b',
                'inseguro': '#ef4444',
                'gestion': '#0ea5e9',
                'seguro': '#10b981',
                'multimedia': '#f43f5e',
                'juegos': '#8b5cf6',
                'voz_ip': '#06b6d4',
                'web': '#6366f1',
                'correo': '#ec4899',
                'remoto': '#f97316',
                'virtualizacion': '#a855f7',
                'monitoreo': '#14b8a6',
                'impresion': '#64748b',
                'backup': '#6366f1',
                'desarrollo': '#10b981',
                'reservado': '#94a3b8'
            };

            if (protocols.categories) {
                for (const [cat, data] of Object.entries(protocols.categories)) {
                    secureData.labels.push(formatCategoryName(cat));
                    secureData.values.push(data.count);
                    secureData.colors.push(colorMap[cat] || '#6b7280');
                    secureData.categories.push(cat);
                }
            }

            if (charts.secure) charts.secure.destroy();

            const secureCtx = document.getElementById('secureChart').getContext('2d');
            charts.secure = new Chart(secureCtx, {
                type: 'pie',
                data: {
                    labels: secureData.labels,
                    datasets: [{
                        data: secureData.values,
                        backgroundColor: secureData.colors,
                        borderWidth: 2,
                        borderColor: '#1e293b',
                        hoverBorderWidth: 3,
                        hoverBorderColor: '#fff',
                        hoverOffset: 15,
                        hoverBackgroundColor: secureData.colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categoria = secureData.categories[index];
                            showProtocolDetails(categoria, false); // Vista simple
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e2e8f0',
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${value} protocolo${value !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index'
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });



            // Gr√°fico de Categor√≠as (antes Top Protocolos)
            const categoryStats = allData.categoryStats || [];

            const categoryChartData = {
                labels: [],
                values: [],
                categories: [],
                colors: []
            };

            categoryStats.forEach(stat => {
                categoryChartData.labels.push(formatCategoryName(stat.categoria));
                categoryChartData.values.push(stat.unique_protocol_count);
                categoryChartData.categories.push(stat.categoria);
                categoryChartData.colors.push(colorMap[stat.categoria] || '#94a3b8');
            });

            if (charts.device) charts.device.destroy();

            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            charts.device = new Chart(deviceCtx, {
                type: 'bar',
                data: {
                    labels: categoryChartData.labels,
                    datasets: [{
                        label: 'Dispositivos',
                        data: categoryChartData.values,
                        backgroundColor: categoryChartData.colors,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const categoria = categoryChartData.categories[index];
                            showProtocolDetails(categoria, true); // Vista detallada con equipos
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1f2937',
                            titleColor: '#e2e8f0',
                            bodyColor: '#e2e8f0',
                            borderColor: '#374151',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y || 0;
                                    return `${value} protocolo${value !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', stepSize: 1 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });


        }

        function updateDevicesTable() {
            const tbody = document.getElementById('devices-tbody');

            if (allData.devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay dispositivos</td></tr>';
                return;
            }

            tbody.innerHTML = allData.devices.map((device, index) => `
                <tr onclick="showDeviceDetail(${index})">
                    <td>${device.hostname || 'N/A'}</td>
                    <td>${device.ip}</td>
                    <td>${device.mac || 'N/A'}</td>
                    <td>${device.total_protocols || 0}</td>
                    <td>${device.ultima_deteccion || 'N/A'}</td>
                </tr>
            `).join('');
        }

        // Mostrar detalles del dispositivo
        async function showDeviceDetail(index) {
            const device = allData.devices[index];
            if (!device) return;

            // Obtener detalles completos del dispositivo
            try {
                const response = await fetch(`api/dashboard.php?action=details&id=${device.id || device.id_equipo}`);
                const data = await response.json();

                // Fetch History
                const historyRes = await fetch(`api/dashboard.php?action=port_history&id=${device.id || device.id_equipo}`);
                const historyData = await historyRes.json();
                const history = historyData.history || [];

                if (!data.success) {
                    alert('Error al cargar detalles del dispositivo');
                    return;
                }

                const deviceData = data.device;
                const ports = data.ports || [];

                // Agrupar puertos por n√∫mero (para evitar duplicados)
                const groupedPorts = {};
                ports.forEach(port => {
                    const key = port.puerto_numero;
                    if (!groupedPorts[key]) {
                        groupedPorts[key] = {
                            puerto_numero: port.puerto_numero,
                            nombre: port.nombre,
                            estado: port.estado,
                            categoria: port.categoria,
                            fechas: []
                        };
                    }
                    if (port.fecha_hora) {
                        groupedPorts[key].fechas.push(port.fecha_hora);
                    }
                });

                // Convertir a array y ordenar por puerto
                const portsArray = Object.values(groupedPorts).sort((a, b) => a.puerto_numero - b.puerto_numero);

                // Construir HTML del modal
                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = `
                    <h2 style="margin-bottom: 30px; color: #3b82f6; text-align: center;">${deviceData.hostname || deviceData.ip}</h2>
                    
                    <div class="device-detail-grid">
                        <div class="detail-card">
                            <h4>Direcci√≥n IP</h4>
                            <div class="value">${deviceData.ip}</div>
                        </div>
                        <div class="detail-card">
                            <h4>Direcci√≥n MAC</h4>
                            <div class="value">${deviceData.mac || 'N/A'}</div>
                        </div>
                        <div class="detail-card">
                            <h4>Fabricante</h4>
                            <div class="value">${deviceData.fabricante_nombre || 'Desconocido'}</div>
                        </div>
                        <div class="detail-card">
                            <h4>Sistema Operativo</h4>
                            <div class="value">${deviceData.so_nombre || 'Desconocido'}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Puertos y Protocolos Detectados</h3>
                        ${portsArray.length > 0 ? `
                            <ul class="protocol-list">
                                ${portsArray.map(port => `
                                    <li>
                                        <div style="font-size: 1.125rem;">
                                            <strong>Puerto ${port.puerto_numero}</strong> - ${port.nombre}
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p style="color: #94a3b8;">No se detectaron protocolos activos actualmente</p>'}
                    </div>

                    <div style="margin-top: 30px; border-top: 1px solid #334155; padding-top: 20px;">
                        <h3 style="margin-bottom: 15px;">Historial de Actividad de Puertos</h3>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="devices-table" style="font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th>Puerto</th>
                                        <th>Protocolo</th>
                                        <th>Inicio</th>
                                        <th>Fin (Duraci√≥n)</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${history.length > 0 ? history.map(h => {
                    const start = new Date(h.fecha_inicio);
                    const end = h.fecha_fin ? new Date(h.fecha_fin) : null;
                    const duration = end ? Math.round((end - start) / 60000) + ' min' : 'Activo';
                    const isActive = !h.fecha_fin;
                    return `
                                            <tr>
                                                <td><span style="color: #60a5fa; font-family: monospace;">${h.numero}</span></td>
                                                <td>${h.nombre}</td>
                                                <td>${start.toLocaleString('es-MX')}</td>
                                                <td>${end ? end.toLocaleString('es-MX') : '-'} <br><span style="font-size:0.8em; color:#94a3b8">(${duration})</span></td>
                                                <td>
                                                    <span class="protocol-badge ${isActive ? 'secure' : 'impresion'}" style="${isActive ? 'background:#10b981' : 'background:#64748b'}">
                                                        ${isActive ? 'ACTIVO' : 'CERRADO'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                }).join('') : '<tr><td colspan="5" style="text-align:center; color: #94a3b8;">Sin historial registrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                // Mostrar modal
                document.getElementById('device-modal').classList.add('active');

            } catch (error) {
                console.error('Error loading device details:', error);
                alert('Error al cargar detalles del dispositivo');
            }
        }

        // Cerrar modal
        function closeDeviceModal() {
            document.getElementById('device-modal').classList.remove('active');
        }

        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDeviceModal();
                closeProtocolModal();
            }
        });

        // Mostrar detalles de protocolos por categor√≠a
        async function showProtocolDetails(categoria, detailed = false) {
            try {
                const action = detailed ? 'protocol_details_detailed' : 'protocol_details';
                const response = await fetch(`api/dashboard.php?action=${action}&categoria=${categoria}`);
                const data = await response.json();

                if (!data.success) {
                    alert('Error al cargar protocolos');
                    return;
                }

                const protocols = data.protocols || [];

                let content = '';

                if (detailed) {
                    // Vista detallada con tablas de equipos
                    content = `
                        <div style="margin-top: 15px; max-height: 70vh; overflow-y: auto;">
                            ${protocols.length > 0 ? `
                                <div class="protocol-groups">
                                    ${protocols.map(p => `
                                        <div class="protocol-group" style="margin-bottom: 30px; background: #1e293b; padding: 20px; border-radius: 8px; border: 1px solid #334155;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h3 style="color: #e2e8f0; margin: 0; display: flex; align-items: center; gap: 10px;">
                                                    <span style="color: #60a5fa; font-family: monospace;">${p.numero}</span>
                                                    ${p.nombre}
                                                </h3>
                                                <span class="protocol-badge ${p.categoria === 'inseguro' ? 'insecure' : 'secure'}">
                                                    ${p.categoria}
                                                </span>
                                            </div>
                                            
                                            ${p.descripcion ? `<p style="color: #94a3b8; font-size: 0.9em; margin-bottom: 15px;">${p.descripcion}</p>` : ''}
                                            
                                            <div class="table-container" style="background: #0f172a; border-radius: 6px; padding: 1px;">
                                                <table class="devices-table" style="margin: 0;">
                                                    <thead>
                                                        <tr>
                                                            <th>Hostname</th>
                                                            <th>IP</th>
                                                            <th>MAC</th>
                                                            <th>√öltima Detecci√≥n</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${p.devices && p.devices.length > 0 ? p.devices.map(d => `
                                                            <tr>
                                                                <td>${d.hostname || 'N/A'}</td>
                                                                <td style="font-family: monospace;">${d.ip}</td>
                                                                <td style="font-family: monospace; font-size: 0.9em;">${d.mac || 'N/A'}</td>
                                                                <td style="font-size: 0.9em;">${new Date(d.last_scan).toLocaleString('es-MX')}</td>
                                                            </tr>
                                                        `).join('') : '<tr><td colspan="4" style="text-align: center; color: #64748b;">Sin dispositivos recientes</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <div style="margin-top: 10px; text-align: right; color: #64748b; font-size: 0.8em;">
                                                Total: ${p.devices ? p.devices.length : 0} dispositivo(s)
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px; color: #94a3b8;">
                                    <p style="font-size: 1.1em;">No hay protocolos detectados en esta categor√≠a</p>
                                </div>
                            `}
                        </div>
                    `;
                } else {
                    // Vista simple solo lista
                    content = `
                        <div style="margin-top: 20px;">
                            ${protocols.length > 0 ? `
                                <ul class="protocol-list">
                                    ${protocols.map(protocol => `
                                        <li>
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong style="font-size: 1.125rem;">Puerto ${protocol.numero}</strong> - ${protocol.nombre}
                                                    <span style="color: #94a3b8; font-size: 0.875rem; margin-left: 10px;">
                                                        (${protocol.dispositivos_usando} dispositivo${protocol.dispositivos_usando > 1 ? 's' : ''})
                                                    </span>
                                                </div>
                                                <span class="protocol-badge ${protocol.categoria === 'inseguro' ? 'insecure' : 'secure'}">
                                                    ${protocol.categoria}
                                                </span>
                                            </div>
                                            ${protocol.descripcion ? `<div style="color: #94a3b8; font-size: 0.875rem; margin-top: 5px;">${protocol.descripcion}</div>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : '<p style="color: #94a3b8; text-align: center;">No hay protocolos detectados en esta categor√≠a</p>'}
                        </div>
                    `;
                }

                const modalBody = document.getElementById('protocol-modal-body');
                modalBody.innerHTML = `
                    <h2 style="margin-bottom: 25px; color: #3b82f6; text-align: center;">
                        Protocolos - ${categoria.charAt(0).toUpperCase() + categoria.slice(1).replace('_', ' ')}
                    </h2>
                    ${content}
                `;

                document.getElementById('protocol-modal').classList.add('active');

            } catch (error) {
                console.error('Error loading protocol details:', error);
                alert('Error al cargar protocolos');
            }
        }

        // Cerrar modal de protocolos
        function closeProtocolModal() {
            document.getElementById('protocol-modal').classList.remove('active');
        }

        function initSSE() {
            // SSE disabled as 'stat-active' element is removed.
        }

        async function exportPDF() {
            try {
                // Obtener datos COMPLETOS
                const response = await fetch('api/dashboard.php?action=export_data');
                const result = await response.json();

                if (!result.success) {
                    alert('Error obteniendo datos para exportar');
                    return;
                }

                const devices = result.data;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });

                // T√≠tulo
                doc.setFontSize(18);
                doc.text('Reporte Completo de Dispositivos - Monitor de Red', 14, 20);
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleString('es-MX')}`, 14, 28);

                // Tabla
                doc.autoTable({
                    startY: 35,
                    head: [['IP', 'Hostname', 'MAC', 'Sistema Op.', 'Fabricante', 'Puertos Abiertos (√ölt. Escaneo)', '√öltima Detecci√≥n']],
                    body: devices.map(d => [
                        d.ip,
                        d.hostname || 'N/A',
                        d.mac || 'N/A',
                        d.os || 'Desconocido',
                        d.manufacturer || 'Desconocido',
                        d.ports_details || 'Ninguno', // Muestra "80/HTTP (10/12 14:00)"
                        d.last_seen
                    ]),
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [30, 41, 59] }, // #1e293b
                    columnStyles: {
                        5: { cellWidth: 80 } // Ancho extra para columna de puertos
                    }
                });

                doc.save(`reporte_red_completo_${new Date().toISOString().slice(0, 10)}.pdf`);

            } catch (error) {
                console.error('Error export PDF:', error);
                alert('Hubo un error al generar el PDF');
            }
        }

        async function exportCSV() {
            try {
                // Obtener datos COMPLETOS
                const response = await fetch('api/dashboard.php?action=export_data');
                const result = await response.json();

                if (!result.success) {
                    alert('Error obteniendo datos para exportar');
                    return;
                }

                const devices = result.data;

                // BOM para Excel
                let csv = '\uFEFF';
                // Headers
                csv += 'IP,Hostname,MAC,Sistema Operativo,Fabricante,Puertos Abiertos,Ultima Deteccion\n';

                devices.forEach(d => {
                    const ports = d.ports_details ? d.ports_details.replace(/\n/g, ' | ') : 'Ninguno';
                    const row = [
                        d.ip,
                        d.hostname || 'N/A',
                        d.mac || 'N/A',
                        d.os || 'Desconocido',
                        d.manufacturer || 'Desconocido',
                        `"${ports}"`, // Comillas para manejar espacios y pipes
                        d.last_seen
                    ];
                    csv += row.join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte_red_${new Date().toISOString().slice(0, 10)}.csv`;
                a.click();

            } catch (error) {
                console.error('Error export CSV:', error);
                alert('Hubo un error al generar el CSV');
            }
        }

        async function refreshData() {
            await loadData();
            // Si la tab de conflictos est√° activa, recargarla tambi√©n
            if (document.getElementById('tab-conflicts').style.display !== 'none') {
                loadConflicts();
            }
        }

        // Tab Logic
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            // Show selected
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            if (tabName === 'conflicts') {
                loadConflicts();
            }
        }

        async function loadConflicts() {
            try {
                const tbody = document.getElementById('conflicts-tbody');

                const response = await fetch('api/dashboard.php?action=get_conflicts');
                const result = await response.json();

                if (!result.success) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #ef4444;">Error cargando conflictos</td></tr>';
                    return;
                }

                const data = result.data;
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #94a3b8;">No se han detectado conflictos</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(c => `
                    <tr>
                        <td style="font-family: monospace;">${c.ip || 'N/A'}</td>
                        <td style="font-family: monospace;">${c.mac || 'N/A'}</td>
                        <td>${c.hostname_conflictivo || 'Desconocido'}</td>
                        <td>${c.descripcion}</td>
                        <td>${new Date(c.fecha_detectado).toLocaleString('es-MX')}</td>
                        <td>
                            <span class="protocol-badge ${c.estado === 'activo' ? 'insecure' : 'secure'}">
                                ${c.estado}
                            </span>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading conflicts:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>